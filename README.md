# cot-dbviewstructure
# DB Structure Viewer для Cotonti Siena


[![Cotonti](https://img.shields.io/badge/Cotonti-Siena%200.9.26-green)](https://github.com/Cotonti/Cotonti)
[![PHP](https://img.shields.io/badge/PHP-8.4%2B-blue)](https://php.net)
![MySQL](https://img.shields.io/badge/MySQL-8.0%2B-yellow) 
![License](https://img.shields.io/badge/License-BSD-red) 
![Version](https://img.shields.io/badge/Version-2.0.0-orange)

Плагин для **просмотра структуры базы данных** и **экспорта** в форматы: **JSON, SQL, CSV, PHP Array**.

<img src="https://raw.githubusercontent.com/webitproff/cot-dbviewstructure/refs/heads/main/dbviewstructure-cotonti-webitproff.webp" alt="DB Structure Viewer для Cotonti Siena CMF">

---


# DB Structure Viewer для Cotonti Siena — Подробная документация

## Введение

DB Structure Viewer — это административный плагин для CMF Cotonti Siena (версия 0.9.26 и выше), предназначенный для интерактивного просмотра структуры базы данных и экспорта таблиц в несколько удобных форматов. Этот документ — подробное руководство по функционалу, архитектуре, настройке, безопасности и сценарию использования плагина. В нём описаны все ключевые возможности, внутренние механизмы и рекомендации по эксплуатации, что делает его полезным как для разработчиков, так и для администраторов.

---

## Кому будет полезен этот плагин

- Системным администраторам, которым нужно быстро проверить структуру БД без доступа к phpMyAdmin или SSH.
- Разработчикам, которые документируют базу данных или готовят миграции/экспорты для тестов.
- QA-инженерам, которым нужно получить небольшие выборки данных для воспроизведения багов.
- Командам, в которых контроль версий и аудит операций важен — благодаря встроенному логированию.

---

## Обзор функционала (подробно)

Плагин предоставляет три главным образом интерфейса в разделе «Инструменты» админ-панели Cotonti: Структура, Экспорт и Логи. Ниже — расширённый список возможностей и сценариев использования.

1. Просмотр таблиц и полей
   - Список всех таблиц в базе, без префикса Cotonti. Это удобно для понимания «чистых» имён сущностей, которые используются в проекте.
   - Для каждой таблицы отображается:
     - Список полей и их порядок.
     - Тип данных (например, INT, VARCHAR(255), TEXT, DATETIME и т.д.).
     - Флаг NULL (YES/NO).
     - Ключи (PRI, UNI, MUL — в привычной нотации MySQL).
     - Значение по умолчанию.
     - Дополнительные свойства (AUTO_INCREMENT и другие).
   - Информация о движке таблицы (InnoDB, MyISAM и пр.) и примерное количество строк.

2. Просмотр содержимого таблицы
   - Возможность быстро получить первые 10 строк для понимания формы данных.
   - Поиск строки по её первичному полю (ID) — полезно при отладке конкретных записей.
   - Вывод данных безопасно экранированный для корректного отображения в шаблоне админки.

3. Экспорт структуры и данных
   - Поддерживаемые форматы: JSON, SQL (дамп), CSV и PHP Array.
   - Три режима экспорта:
     - Только структура (без данных) — для документирования схемы.
     - Структура + первые 10 строк — для создания компактного экспорта-примера.
     - Полный экспорт всех строк — полноценный дамп данных (подходит для переносов/бэкапов, если объём допустим).
   - Поддержка массового выбора таблиц и опции «Выделить все».
   - Конфигурация позволяет: сохранять файл на сервер в папку export/, отдать файл в ответе браузеру, или и то и другое одновременно.
   - Опция упаковки в ZIP: если включена, файлы после создания могут быть сжаты в единый архив.
   - Логирование создаваемых экспортов (имя файла, формат, количество таблиц, признак наличия данных, timestamp) для последующего аудита.

4. Логирование и история операций
   - Таблица логов `cot_dbviewstructure_logs` хранит записи об операциях экспорта.
   - В админке доступна страница с пагинацией и ссылками на скачивание файлов экспорта.
   - Логи помогают отслеживать, кто (при наличии соответствующей интеграции с системой авторизации) и когда выполнял экспорты.

5. Безопасность работы с БД
   - Имена таблиц и полей экранируются функцией-обёрткой, чтобы избежать ошибок и частично снизить риск инъекций при работе с динамическими идентификаторами.
   - Для передачи значений в SQL используются подготовленные выражения (prepared statements), где это возможно.
   - Доступ к инструменту и к отдельным действиям (экспорт/скачивание) ограничивается стандартными правами Cotonti (plug-auth).

6. Локализация
   - Плагин содержит языковые файлы: русскую и английскую версии, готова поддержка дополнительных языков (ua и др.).
   - Все тексты интерфейса вынесены в языковые файлы, что упрощает перевод и адаптацию.


## Преимущества использования

1. **Удобство** — все функции доступны прямо из панели администратора Cotonti.
2. **Гибкость экспорта** — можно выбрать формат, объём данных и конкретные таблицы.
3. **Безопасность** — используется защита от SQL-инъекций, безопасное обращение к БД.
4. **Прозрачность** — при включённом логировании сохраняется история всех экспортов.
5. **Совместимость** — работает с PHP 8.4+ и MySQL 8.0+.
6. **Локализация** — доступен на трёх языках (ru, en, ua).

---

## Установка

1. Скачайте архив с [GitHub **DB Structure Viewer для Cotonti Siena**](https://github.com/webitproff/cot-dbviewstructure/)
2. Распакуйте архив и папку `dbviewstructure` закачайте в папку `plugins`
3. Зайдите в **Админка → Плагины → Установить → dbviewstructure**
4. Настройте:
- **export_path** — Путь к папке экспорта (по умолчанию `plugins/dbviewstructure/export/`)
- **log_enabled** — Включить логирование экспортов
- **export_to_browser** — Одновременный экспорт в браузер
- **max_rows_per_page** — Кол-во записей на странице логов
- **pack_to_zip** — Упаковывать файлы в ZIP

  
## Использование

### Админка → Другие → DB Structure Viewer

#### Вкладки:

| Вкладка | Что делает |
|--------|-----------|
| **Структура** | Список таблиц + детальная информация |
| **Экспорт** | Выбор таблиц, формата, объёма данных |
| **Логи** | История экспортов (если включено) |

---

## Экспорт: что можно

| Формат | Структура | 10 строк | Все строки |
|-------|-----------|----------|------------|
| JSON  | Yes       | Yes      | Yes        |
| SQL   | Yes       | Yes      | Yes        |
| CSV   | Yes       | Yes      | Yes        |
| PHP   | Yes       | Yes      | No (слишком большой) |

> **PHP Array** — только для малых объёмов. При "все строки" — **ошибка**.

---

## Техническая архитектура (внутренне устройство)

### Структура директорий и файлов
```
plugins/dbviewstructure/
├── dbviewstructure.setup.php
├── dbviewstructure.tools.php
├── inc/
│   └── dbviewstructure.functions.php
├── tpl/
│   └── dbviewstructure.tools.tpl
├── export/
├── lang/
│   ├── dbviewstructure.ru.lang.php
│   └── dbviewstructure.en.lang.php
└── setup/
   ├── dbviewstructure.install.sql
   └── dbviewstructure.uninstall.sql
```

Плагин построен в соответствии со стандартной структурой Cotonti и разделён на логические слои:

- `dbviewstructure.setup.php` — регистрация расширения в системе, метаданные (версия, автор), и определение конфигурационных параметров плагино-ориентированного UI.
- `dbviewstructure.tools.php` — основной контроллер работы в админ-панели. Обрабатывает входные параметры (GET/POST), подготавливает данные для шаблона, вызывает функции экспорта/получения структуры и отображает шаблон.
- `inc/dbviewstructure.functions.php` — набор вспомогательных функций:
  - Получение списка таблиц `dbview_get_tables()`.
  - Получение подробной информации о таблице `dbview_get_table_info()`.
  - Экспорт в форматы `dbview_export_tables()` и `dbview_export_tables_full()`.
  - Создание ZIP-архива `dbview_pack_to_zip()`.
  - Утилиты экранирования идентификаторов и обработки ошибок/логирования.
- `tpl/dbviewstructure.tools.tpl` — шаблон интерфейса на XTemplate/Bootstrap, отвечает за визуальное представление и JS-интерактивность (например, select_all для экспорта).
- `setup/dbviewstructure.install.sql` — SQL-скрипт для создания таблицы логов при установке.
- `lang/` — языковые файлы для перевода интерфейса.

Преимущество такой архитектуры — простота сопровождения и расширяемость: логика отделена от представления, язык и конфигурация вынесены отдельно.

---

## Примеры использования и сценарии

1. Быстрый осмотр структуры после деплоя
   - Задача: необходимо убедиться, что новая колонка migrate_flag появилась во всех нужных таблицах.
   - Действия: открыть Структура → Таблицы и поля → найти названия таблиц и проверить наличие поля в списке полей каждой таблицы.

2. Получение примера данных для тестирования
   - Задача: QA просит показать пример записей для таблицы orders.
   - Действия: Структура → Просмотр строк → выбрать таблицу orders → просмотреть первые 10 строк, при необходимости указать конкретный ID.

3. Подготовка экспорта для миграции
   - Задача: перенести структуру и данные нескольких таблиц на тестовый сервер.
   - Действия: Экспорт → выбрать таблицы → выбрать формат SQL → выбрать режим «Все строки» → включить упаковку в ZIP при необходимости → скачать архив (через браузер или из папки export/).

4. Аудит изменений
   - Задача: отследить, когда был выполнен экспорт с данными и кто это сделал.
   - Действия: Логи → просмотреть соответствующие записи с информацией о файлах и времени создания.

---

## Рекомендации по конфигурации и эксплуатации

- Установите права на папку `plugins/dbviewstructure/export/` как минимум 755. Если сервер настроен так, что веб-процесс должен иметь право записи, может потребоваться 775 или 775 для группы веб-сервера.
- При больших объёмах данных предпочитайте экспорт через SQL и хранение файлов за пределами веб-директории, либо обеспечьте доступ к export/ через безопасный механизм скачивания. По умолчанию плагин отдаёт файлы через скрипт, что снижает риски прямого доступа.
- Включайте логирование для проектов, где важна отслеживаемость операций. Логи не содержат чувствительных данных, только метаданные операций (имя файла, формат, количество таблиц, флаг с данными, timestamp).
- Не используйте режим «Все строки» для таблиц с огромным количеством записей, если сервер не подготовлен: это может привести к исчерпанию памяти/времени выполнения. Для таких случаев лучше использовать дамп средствами сервера (mysqldump) и управлять потоковой загрузкой/разбиением по частям.
- Регулярно очищайте старые файлы в папке export/ и/или реализуйте ротацию: храните в течение ограниченного времени, чтобы не переполнить диск.

---

## Безопасность — подробности

- Экранирование идентификаторов: функция `dbview_quote_identifier()` обёртывает имена в обратные апострофы и экранирует внутренние символы, предотвращая некорректный разбор идентификаторов.
- Подготовленные запросы: при передаче динамических значений (например, ID) используются подготовленные параметры PDO, что уменьшает риск SQL-инъекций.
- Контроль прав: доступ к инструментам ограничивается возможностями Cotonti (права plug/auth). Операции скачивания и экспорта требуют прав администратора плагина.
- Логи не содержат содержимого экспортированных данных — в логах хранится только имя файла и параметры экспорта. Это важно для соответствия безопасности и приватности.
- Download-релиз через скрипт: чтобы предотвратить прямой доступ к файлам export/, загрузка организована через скрипт плагина, который дополнительно проверяет корректность пути и права на доступ.

---

## Тонкости реализации (важные замечания)

- PHP Array формат не поддерживает экспорт полного набора строк (опция недоступна при выборе «все строки»), потому что `var_export()` может генерировать чрезвычайно большие файлы и потенциально привести к превышению лимитов памяти/времени выполнения.
- ZIP-архив создаётся с использованием расширения ZipArchive. Если расширение отсутствует на сервере, архивирование пропустится, а операция будет залогирована.
- Функция `dbview_get_tables()` использует `SHOW TABLES LIKE ?` с префиксом базы Cotonti (`Cot::$db_x`) для корректного сбора только таблиц CMS. При кастомной префиксации важно корректно настроить параметр Cotonti `$db_x`.
- При экспорте SQL используется `SHOW CREATE TABLE` для получения точной DDL-схемы таблицы, что гарантирует корректность восстановления структуры на другой базе.

---

## Отладка и устранение неполадок

- Если таблицы не отображаются:
  - Проверьте значение префикса `Cot::$db_x` и наличие таблиц с указанным префиксом.
  - Убедитесь, что пользователь базы имеет права на `SHOW TABLES` и `SHOW CREATE TABLE`.
- Если файлы не записываются в export/:
  - Проверьте права на папку и владельца процесса веб-сервера.
  - Убедитесь, что путь экспорта в настройках плагина указан корректно и существует.
- Если ZIP не создаётся:
  - Проверьте доступность расширения PHP `zip` (ZipArchive).
- Если экспорт "всё строки" падает по памяти:
  - Используйте дамп средствами сервера (mysqldump) или разбивайте экспорт по таблицам и частям.

---

## Частые вопросы (FAQ)

В: Можно ли экспортировать только конкретные поля таблицы?  
О: Текущая версия экспортирует полную структуру и/или данные таблицы. Фильтрация по полям не реализована по умолчанию, но добавление такой опции возможно через доработку контроллера и функций экспорта.

В: Где хранятся лог-файлы экспортов?  
О: Логи операций хранятся в таблице `cot_dbviewstructure_logs` в базе данных, а сами файлы — в папке `plugins/dbviewstructure/export/` (или доступны для скачивания через интерфейс плагина).

В: Насколько безопасно отдавать файлы через браузер?  
О: Файлы отдаются через скрипт с проверкой, поэтому прямой доступ по URL к export/ можно жестко ограничить. Рекомендуется размещать export/ вне публичного корня или настроить доступ, исходя из требований безопасности.

---

## Как расширять плагин — идеи и точки входа

- Добавить экспорт в форматы XML или YAML для интеграций с другими системами.
- Реализовать потоковую выгрузку больших таблиц (chunked export) для минимизации использования памяти.
- Добавить возможность выбирать только часть столбцов при экспорте.
- Интегрировать с системой аутентификации/журналирования Cotonti для записи, кто именно инициировал экспорт (пока в лог записывается только имя файла и параметры — можно добавить ID пользователя и IP).
- Добавить CLI-команды для плановых экспортов и интеграции с бэкап-системой сервера.

---

## Лицензия

BSD License © 2025 webitproff

---

## Поддержка и вклад

Исходный код и issues находятся в репозитории: https://github.com/webitproff/cot-dbviewstructure  
Pull-requests приветствуются. Если вы планируете серьёзную доработку, откройте issue, опишите задачу и обсудим архитектурные изменения.

---

## Контакты автора

Автор: webitproff  
GitHub: https://github.com/webitproff/cot-dbviewstructure

